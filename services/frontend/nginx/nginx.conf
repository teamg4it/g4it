worker_processes auto;

pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log warn;

    include /etc/nginx/mime.types;

    gzip                    on;
    gzip_comp_level         6;
    gzip_vary               on;
    gzip_min_length         256;
    gzip_proxied            any;
    gzip_types              text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
    gzip_buffers            16 8k;

    server {
        listen *:4200;

        root /usr/share/nginx/html;
        disable_symlinks if_not_owner from=/usr/share/nginx/html;

        server_tokens off;

        add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' https://fonts.gstatic.com; object-src 'none'; frame-ancestors 'none'; connect-src 'self' https://login.microsoftonline.com https://graph.microsoft.com;";

        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "SAMEORIGIN" always;

        # Block path traversal in query string (multiple encoding variations)
        if ($args ~* "(\.\./|\.\.\\|%2e%2e|%252e|%c0%ae|%c1%9c|\.\.%2f|\.\.%5c)") {
            return 403;
        }

        # Block null bytes and other dangerous characters in query string
        if ($args ~* "(%00|%0d%0a|\\x00)") {
            return 403;
        }

        # Block absolute path attempts in query string
        if ($args ~* "^(/etc/|/proc/|/sys/|/dev/|/boot/|/root/|/var/|/usr/)") {
            return 403;
        }

        # Block path traversal attempts in URI (multiple variations)
        location ~ "(\.\./|\.\.\\|%2e%2e|%252e|%c0%ae|%c1%9c)" {
            return 403;
        }

        # Block encoded slashes and backslashes
        location ~ "(%2f|%5c|%252f|%255c)" {
            return 403;
        }

        # Block null bytes in URI
        location ~ "(%00|%0d%0a|\\x00)" {
            return 403;
        }

        # Block direct access to sensitive system paths
        location ~* "^/(etc|proc|sys|dev|boot|root|var|tmp|usr|bin|sbin)" {
            deny all;
        }

        # Block access to hidden files and directories
        location ~ /\. {
            deny all;
        }

        # Block access to backup and temporary files
        location ~* "\.(bak|backup|old|save|swp|tmp|temp|~)$" {
            deny all;
        }

        location / {
            index index.prod.html index.prod.htm;
            try_files $uri $uri/ /index.prod.html =404;
        }

        # This part is only used if the image is used locally
        # This enpoint should not be accessible in deployed env

        proxy_request_buffering off;
        client_max_body_size 0;
    }
}
