databaseChangeLog:
  - changeSet:
      id: migrate-digital-service-to-version
      author: G4IT Dev Team
      changes:
        - sql:
            sql: |
              INSERT INTO digital_service_version (
                uid,
                description,
                last_calculation_date,
                creation_date,
                last_update_date,
                item_id,
                version_type,
                note_id,
                criteria,
                created_by,
                task_id
              )
              SELECT
                gen_random_uuid(),
                'version 1',
                ds.last_calculation_date,
                ds.creation_date,
                ds.last_update_date,
                ds.uid,
                'active',
                ds.note_id,
                ds.criteria,
                ds.user_id,
                NULL
              FROM digital_service ds
              WHERE ds.uid NOT IN (
                SELECT item_id FROM digital_service_version
              );

  - changeSet:
      id: populate-digital-service-version-task-id
      author: G4IT Dev Team
      changes:
        - sql:
            splitStatements: true
            stripComments: false
            sql: |
              -- Populate task_id in digital_service_version from task table
              
              UPDATE digital_service_version dsv
              SET task_id = t.id
              FROM task t
              WHERE dsv.item_id = t.digital_service_uid
                AND dsv.task_id IS NULL
                AND t.digital_service_version_uid IS NULL;
